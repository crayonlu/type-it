# 神秘配网

## 背景

早有耳闻能使用妙妙UDP53进行校园网的秘密使用，于是今天下午趁着有时间决定尝试
配置（？）结果牛魔滴因为对计网还是不怎么熟悉，到处碰壁，于是写下了这个文章复盘一下整个过程....

## 最终目标

```shell
|-------------|    |-------------|
|             |    |             |
|    Phone    |    |             |
|             |--->|    Pve11    |---> Internet
|     PC      |    |             |
|             |    |             |
|-------------|    |-------------|
```

或者

```shell
|-------------|    |-------------|     |-------------|
|             |    |             |     |             |
|    Phone    |    |   Public    |     |             |
|             |--->|   network   |---> |    Pve11    |---> Internet
|     PC      |    |   server    |     |             |
|             |    |             |     |             |
|-------------|    |-------------|     |-------------|
```

## 操作复盘

### 1. 创建pve11虚拟机

创建了一个ubuntu虚拟机，分配了2核4G内存64G硬盘(嘻嘻开大了)

### 2. 配置pve11网络

在这个小鸡上下载了zerotier

```shell
curl -s https://install.zerotier.com | sudo bash
sudo zerotier-cli join xxxxxxxxxx
```

然后去zerotier上authorize这个小鸡

### 3.ssh上小鸡进行操作

考虑了几种方式:

#### WireGuard

但是对于流量的支持不好 虽然配置起来是最简单的

#### Hysteria2

尝试了这个方案

1. 使用docker部署 

```shell
镜像名: tobyxdd/hysteria
端口映射: 443:443/udp
卷映射: /opt/hysteria:/etc/hysteria
环境变量: 无需特殊配置
重启策略: always
```

2. 接下来操作config

```shell
# 在1Panel文件管理中创建 /opt/hysteria/config.yaml
listen: :443

tls:
  cert: /etc/hysteria/cert.crt
  key: /etc/hysteria/private.key

auth:
  type: password
  password: "your_strong_password_here"

masquerade:
  type: proxy
  proxy:
    url: https://www.bing.com
    rewriteHost: true

bandwidth:
  up: 100 mbps
  down: 200 mbps

acl:
  inline:
    - proxy(all)
```

3. 生成自签证书

```shell
sudo mkdir -p /opt/hysteria
cd /opt/hysteria

sudo openssl req -x509 -nodes -newkey rsa:4096 -keyout private.key -out cert.crt -subj "/CN=bing.com" -days 36500

sudo chmod 600 private.key
sudo chmod 644 cert.crt
```

4. 测试一下

```shell
sudo netstat -tulpn | grep 443
```

5. 客户端配置

使用v2rayNG or ...（代理工具随意）

```shell
server: VM_IP:443
auth: "your_strong_password_here"
tls:
  sni: bing.com  
  insecure: true
socks5:
  listen: 127.0.0.1:1080
```

6. 接下来就报错了

```shell
2025-09-16T08:24:08Z    INFO    server mode
2025-09-16T08:24:08Z    FATAL   failed to load server config    {"error": "invalid config: acl.inline: error at line 1: outbound proxy not found"}
```

7. 是acl的问题

删掉acl 好了！ 
用v2rayNG一连：失败: io:read/write on closed pipe<br>
？？？这尼玛是为什么啊 本地回环？不应该啊 于是就把v2rayNG的规则换成了10.147.x.x直连 密码的还是不行？？？
后来进行了各种尝试 最终无功而返

#### socks5

最后尝试的是socks5

1. 安装dante-server

```shell
sudo apt install dante-server
```

2. 配置dante

```shell
sudo nano /etc/danted.conf
logoutput: stderr
internal: 0.0.0.0 port = 1080
external: ens18 // 出口
socksmethod: none

client pass {
    // 限制客户端ip
    from: 10.147.20.0/24 to: 0.0.0.0/0
}

sock pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
}
```

3. 测试

```shell
在本地和小鸡上都跑一边看看一不一样 如果一样就是通了
curl --socks5 10.147.xx.xx:1080 https://ipinfo.io/ip
```

4. 配置客户端即可

但是密码的 电脑上可以 手机上不可以 这回真红了

5. 求救

摇人了 使用神秘et udp53解决 虽然这一过程很唐 最后也只是个半成品 但是学到了挺多喵